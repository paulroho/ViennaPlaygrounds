<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>Playgrounds in Vienna</title>
		<style>
			body {
				font-family: Helvetica, Arial, sans-serif;
			}
			#map {
				width : 1000px;
				height: 1000px;
			}
		</style>
		<script src="http://maps.google.com/maps/api/js?key=AIzaSyBxQCJi1jVfL3LOOT-6GcW6ojL0qP5b2WQ" type="text/javascript">//</script>
		<script type="text/javascript">//
			window.onload = function() {
				const dataUri = "http://data.wien.gv.at/daten/geo?service=WFS&request=GetFeature&version=1.1.0&typeName=ogdwien:SPIELPLATZOGD&srsName=EPSG:4326&outputFormat=json";
				updateSourceDisplay(dataUri);
				
				loadJson(dataUri, function(features) {
					let mapTargetElement = document.getElementById('map');
					let map = prepareMap(mapTargetElement);
					updateNumber(features);
					showOnMap(map, features);
				});
			};
			
			function updateSourceDisplay(dataUri) {
				let sourceDisplayLink = document.getElementById("sourceLink");
				let sourceDisplay = document.getElementById("source");
				sourceDisplayLink.href = dataUri;
				sourceDisplayLink.textContent = dataUri;
			}
			
			function prepareMap(targetElement) {
				var map = new google.maps.Map(targetElement, {
				  zoom: 12,
				  center: new google.maps.LatLng(48.2, 16.35),
				  mapTypeId: google.maps.MapTypeId.ROADMAP
				});
				return map;
			}

			function loadJson(uri, success) {
				var request = new XMLHttpRequest;
				request.onload = function(e) {
					if (request.status >= 200 && request.status < 400) {
						var data = JSON.parse(request.responseText);
						success(data.features);
					}
					else {
						console.warn("uje");
					}
				};
				request.onerror = function() {
					console.error("Error loading data!");
					alert("Error loading data!");
				};
				request.open("GET", uri, true);
				request.send();
			}
			
			function updateNumber(features) {
				document.getElementById("number").innerText = features.length;
			}
			
			function showOnMap(map, features) {
				var infowindow = new google.maps.InfoWindow();
				for (let i=0; i<features.length; i++) {
					let feature = features[i];
					showFeatureOnMap(map, feature, infowindow);
				}
			}
			
			function showFeatureOnMap(map, feature, infowindow) {
				let marker = new google.maps.Marker({
					position: new google.maps.LatLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]),
					map: map
				});
				
				google.maps.event.addListener(marker, 'click', (function(marker, i) {
					return function() {
					  infowindow.setContent("<p><b>" + feature.properties.STANDORT + "</b></p>" + "<p>" + feature.properties.ANGEBOT + "</p>");
					  infowindow.open(map, marker);
					}
				})(marker, feature));
			}
		</script>
	</head>
	<body>
		<h1>Vienna Playgrounds</h1>
		<p>Found <span id="number"></span> playgrounds:</p>
		<div id="map">&nbsp;</div>
		<p>Source: <a id="sourceLink"></a></p>
	</body>
</html>